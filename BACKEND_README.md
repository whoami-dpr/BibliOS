# üìö BibliOS - Backend SQLite

## üéØ **Descripci√≥n**

Este es el backend completo de **BibliOS**, un sistema de gesti√≥n bibliotecaria offline desarrollado con **Electron** y **SQLite**. El sistema funciona completamente sin conexi√≥n a internet y almacena todos los datos localmente en el dispositivo.

## üèóÔ∏è **Arquitectura**

```
BibliOS/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ main/                    # Proceso principal de Electron
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.js             # Punto de entrada principal
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ preload.js          # Script de precarga seguro
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database/           # Servicios de base de datos
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database.js     # Servicio principal de SQLite
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ipc/                # Comunicaci√≥n entre procesos
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ databaseHandlers.js # Manejadores IPC
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ services/           # Servicios adicionales
‚îÇ   ‚îî‚îÄ‚îÄ renderer/               # Frontend React (ya existente)
‚îú‚îÄ‚îÄ database/                   # Archivos de base de datos
‚îî‚îÄ‚îÄ electron/                   # Configuraci√≥n de Electron
```

## üöÄ **Caracter√≠sticas Principales**

### **‚úÖ Base de Datos SQLite**
- **Completamente offline** - No requiere conexi√≥n a internet
- **Datos persistentes** - Se guardan en el dispositivo del usuario
- **R√°pida y eficiente** - SQLite es muy ligero y r√°pido
- **Relaciones complejas** - Soporta foreign keys y joins
- **Backup autom√°tico** - Sistema de respaldos integrado

### **‚úÖ Sistema Multi-tenant**
- **M√∫ltiples bibliotecas** - Cada usuario puede gestionar varias bibliotecas
- **Aislamiento de datos** - Cada biblioteca tiene sus propios datos
- **Biblioteca activa** - Sistema de cambio entre bibliotecas

### **‚úÖ Gesti√≥n Completa**
- **Bibliotecas** - Informaci√≥n y configuraci√≥n
- **Libros** - Cat√°logo completo con ISBN, categor√≠as, ubicaciones
- **Socios** - Usuarios registrados con historial
- **Pr√©stamos** - Control de pr√©stamos, devoluciones y vencimientos
- **Estad√≠sticas** - Reportes en tiempo real

## üõ†Ô∏è **Instalaci√≥n y Configuraci√≥n**

### **1. Dependencias Requeridas**
```bash
npm install better-sqlite3 electron-store
```

### **2. Estructura de Archivos**
Los archivos principales ya est√°n creados:
- `src/main/database/database.js` - Servicio de base de datos
- `src/main/ipc/databaseHandlers.js` - Manejadores IPC
- `src/main/preload.js` - Script de precarga
- `src/main/main.js` - Proceso principal actualizado
- `frontend/src/hooks/useDatabase.js` - Hook personalizado

### **3. Configuraci√≥n de Electron**
El archivo `main.js` ya est√° configurado con:
- Context isolation habilitado
- Preload script configurado
- Manejo de errores robusto
- Cierre limpio de la base de datos

## üìä **Modelo de Base de Datos**

### **Tabla: bibliotecas**
```sql
CREATE TABLE bibliotecas (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,
    direccion TEXT,
    telefono TEXT,
    email TEXT,
    responsable TEXT,
    horarios TEXT,
    descripcion TEXT,
    fechaCreacion DATETIME DEFAULT CURRENT_TIMESTAMP,
    activa BOOLEAN DEFAULT 0
);
```

### **Tabla: libros**
```sql
CREATE TABLE libros (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    titulo TEXT NOT NULL,
    autor TEXT NOT NULL,
    isbn TEXT,
    categoria TEXT,
    editorial TEXT,
    anioPublicacion INTEGER,
    cantidad INTEGER DEFAULT 1,
    disponibles INTEGER DEFAULT 1,
    ubicacion TEXT,
    estado TEXT DEFAULT 'disponible',
    descripcion TEXT,
    bibliotecaId INTEGER,
    FOREIGN KEY (bibliotecaId) REFERENCES bibliotecas(id) ON DELETE CASCADE
);
```

### **Tabla: socios**
```sql
CREATE TABLE socios (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL,
    email TEXT,
    telefono TEXT,
    direccion TEXT,
    fechaRegistro DATETIME DEFAULT CURRENT_TIMESTAMP,
    estado TEXT DEFAULT 'activo',
    observaciones TEXT,
    bibliotecaId INTEGER,
    FOREIGN KEY (bibliotecaId) REFERENCES bibliotecas(id) ON DELETE CASCADE
);
```

### **Tabla: prestamos**
```sql
CREATE TABLE prestamos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    libroId INTEGER,
    socioId INTEGER,
    bibliotecaId INTEGER,
    fechaPrestamo DATETIME DEFAULT CURRENT_TIMESTAMP,
    fechaDevolucion DATETIME,
    fechaDevolucionReal DATETIME,
    estado TEXT DEFAULT 'activo',
    observaciones TEXT,
    FOREIGN KEY (libroId) REFERENCES libros(id) ON DELETE CASCADE,
    FOREIGN KEY (socioId) REFERENCES socios(id) ON DELETE CASCADE,
    FOREIGN KEY (bibliotecaId) REFERENCES bibliotecas(id) ON DELETE CASCADE
);
```

## üîå **APIs Disponibles**

### **Bibliotecas**
```javascript
// Crear biblioteca
await window.electronAPI.createBiblioteca(bibliotecaData);

// Obtener todas las bibliotecas
await window.electronAPI.getBibliotecas();

// Obtener biblioteca activa
await window.electronAPI.getBibliotecaActiva();

// Actualizar biblioteca
await window.electronAPI.updateBiblioteca(id, updates);

// Eliminar biblioteca
await window.electronAPI.deleteBiblioteca(id);

// Activar biblioteca
await window.electronAPI.activateBiblioteca(id);
```

### **Libros**
```javascript
// Crear libro
await window.electronAPI.createLibro(libroData);

// Obtener libros con filtros
await window.electronAPI.getLibros(bibliotecaId, { 
  search: 't√≠tulo', 
  categoria: 'Ficci√≥n' 
});

// Actualizar libro
await window.electronAPI.updateLibro(id, updates);

// Eliminar libro
await window.electronAPI.deleteLibro(id);
```

### **Socios**
```javascript
// Crear socio
await window.electronAPI.createSocio(socioData);

// Obtener socios con filtros
await window.electronAPI.getSocios(bibliotecaId, { 
  search: 'nombre', 
  estado: 'activo' 
});

// Actualizar socio
await window.electronAPI.updateSocio(id, updates);

// Eliminar socio
await window.electronAPI.deleteSocio(id);
```

### **Pr√©stamos**
```javascript
// Crear pr√©stamo
await window.electronAPI.createPrestamo(prestamoData);

// Obtener pr√©stamos
await window.electronAPI.getPrestamos(bibliotecaId, { 
  estado: 'activo' 
});

// Devolver libro
await window.electronAPI.devolverLibro(prestamoId);
```

### **Estad√≠sticas**
```javascript
// Estad√≠sticas generales
await window.electronAPI.getBibliotecaStats(bibliotecaId);

// Pr√©stamos por mes
await window.electronAPI.getPrestamosPorMes(bibliotecaId, 6);

// Libros por categor√≠a
await window.electronAPI.getLibrosPorCategoria(bibliotecaId);
```

## üé£ **Hook Personalizado useDatabase**

### **Uso B√°sico**
```javascript
import { useDatabase } from './hooks/useDatabase';

function MiComponente() {
  const { 
    createBiblioteca, 
    getBibliotecas, 
    loading, 
    error 
  } = useDatabase();

  // Usar las funciones...
}
```

### **Funciones Disponibles**
- **Estado**: `loading`, `error`
- **Utilidades**: `clearError`, `isElectronAvailable`
- **Todas las operaciones de base de datos**
- **Informaci√≥n del sistema**

## üöÄ **Ejecutar la Aplicaci√≥n**

### **Modo Desarrollo**
```bash
# Terminal 1: Frontend React
cd frontend
npm run dev

# Terminal 2: Electron
npm run dev:electron
```

### **Modo Producci√≥n**
```bash
# Construir y ejecutar
npm run build
npm start
```

## üîß **Configuraci√≥n Avanzada**

### **Variables de Entorno**
```bash
# Modo desarrollo
NODE_ENV=development

# Modo producci√≥n
NODE_ENV=production
```

### **Ruta de Base de Datos**
La base de datos se crea autom√°ticamente en:
- **Windows**: `%APPDATA%/BibliOS/biblios.db`
- **macOS**: `~/Library/Application Support/BibliOS/biblios.db`
- **Linux**: `~/.config/BibliOS/biblios.db`

## üìù **Logs y Debugging**

### **Logs de la Base de Datos**
```javascript
// En la consola de Electron
console.log('Base de datos inicializada en:', dbPath);
console.log('Tablas creadas correctamente');
```

### **Errores IPC**
```javascript
// Los errores se capturan autom√°ticamente
ipcMain.handle('database:operation', async (event, data) => {
  try {
    return await db.operation(data);
  } catch (error) {
    console.error('Error en operation:', error);
    throw error;
  }
});
```

## üß™ **Testing y Validaci√≥n**

### **Datos de Ejemplo**
```javascript
// Insertar datos de prueba
await window.electronAPI.insertSampleData(bibliotecaId);
```

### **Validaciones Integradas**
- **ISBN**: Validaci√≥n de formato ISBN-10 e ISBN-13
- **Email**: Validaci√≥n de formato de email
- **Fechas**: Validaci√≥n y formateo autom√°tico
- **Estados**: Control de estados v√°lidos

## üîí **Seguridad**

### **Context Isolation**
- **Habilitado** por defecto
- **APIs expuestas** de forma segura
- **Sin acceso directo** a Node.js desde el renderer

### **Validaci√≥n de Entrada**
- **Sanitizaci√≥n** de datos
- **Validaci√≥n** de tipos y formatos
- **Prevenci√≥n** de inyecciones SQL

## üìö **Recursos Adicionales**

### **Documentaci√≥n SQLite**
- [SQLite Official](https://www.sqlite.org/)
- [Better-SQLite3](https://github.com/JoshuaWise/better-sqlite3)

### **Documentaci√≥n Electron**
- [Electron IPC](https://www.electronjs.org/docs/latest/tutorial/ipc)
- [Context Isolation](https://www.electronjs.org/docs/latest/tutorial/context-isolation)

### **Documentaci√≥n React**
- [React Hooks](https://reactjs.org/docs/hooks-intro.html)
- [Custom Hooks](https://reactjs.org/docs/hooks-custom.html)

## üÜò **Soluci√≥n de Problemas**

### **Error: "window.electronAPI is undefined"**
- Verificar que `preload.js` est√© configurado correctamente
- Asegurar que `contextIsolation: true` est√© habilitado

### **Error: "Database connection failed"**
- Verificar permisos de escritura en el directorio de datos
- Comprobar que `better-sqlite3` est√© instalado correctamente

### **Error: "IPC handler not found"**
- Verificar que los manejadores IPC est√©n registrados
- Comprobar que `DatabaseHandlers` se inicialice correctamente

## üéâ **¬°Listo para Usar!**

El backend de BibliOS est√° completamente implementado y listo para usar. Todas las funcionalidades principales est√°n disponibles a trav√©s de las APIs de Electron, y el hook personalizado `useDatabase` facilita la integraci√≥n con React.

**¬°Disfruta desarrollando tu sistema bibliotecario offline!** üìö‚ú®

